name: Deploy Application

on:
  # Manual deployment trigger only - always deploys from dev branch
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (default latest)"
        required: false
        default: "latest"

permissions:
  contents: read
  packages: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        # Always use dev branch as default
        # No ref specified = uses current branch (dev)

      - name: Azure CLI Login
        run: |
          az login --service-principal \
            --username ${{ secrets.AZURE_CLIENT_ID }} \
            --password ${{ secrets.AZURE_CLIENT_SECRET }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }}
          az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get resource information
        id: azure_resources
        run: |
          # Always use dev environment since that's where our resources exist
          ENVIRONMENT=dev
          
          # Get storage account name from the resource group
          STORAGE_ACCOUNT=$(az storage account list \
            --resource-group play-learn-spark-${ENVIRONMENT}-rg \
            --query "[0].name" \
            --output tsv)
          
          echo "ENVIRONMENT=${ENVIRONMENT}" >> $GITHUB_OUTPUT
          echo "STORAGE=$STORAGE_ACCOUNT" >> $GITHUB_OUTPUT

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Build frontend
        working-directory: client
        run: |
          npm ci
          # Container Apps will provide HTTPS by default, but we need to get the FQDN after Terraform apply
          # For now, we'll use a placeholder and update it after Terraform runs
          echo "VITE_API_BASE_URL=PLACEHOLDER_BACKEND_URL" > .env.production
          npm run build

      - name: Set deployment variables
        id: deploy_vars
        run: |
          # Always deploy from dev branch (default) with specified image tag
          BRANCH="dev"
          IMAGE_TAG="${{ github.event.inputs.image_tag || 'latest' }}"
          
          echo "BRANCH=${BRANCH}" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Deploying from dev branch (default) with image tag: ${IMAGE_TAG}"

      - name: Deploy backend container app using Terraform
        working-directory: azure-infra
        run: |
          # Initialize Terraform
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_STATE_RG }}" \
            -backend-config="storage_account_name=${{ secrets.TF_STATE_SA }}" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=play-learn-spark-dev.tfstate"
          
          # Apply Terraform with the determined image tag
          terraform apply -auto-approve \
            -var environment=dev \
            -var image_tag=${{ steps.deploy_vars.outputs.IMAGE_TAG }} \
            -var mongodb_atlas_connection_string="${{ secrets.MONGODB_ATLAS_URI }}" \
            -var jwt_secret="${{ secrets.JWT_SECRET }}" \
            -var google_ai_api_key="${{ secrets.GOOGLE_AI_API_KEY }}" \
            -var github_username=${{ github.actor }} \
            -var github_token="${{ secrets.GITHUB_TOKEN }}"

      - name: Rebuild frontend with correct backend URL
        working-directory: client
        run: |
          # Get the actual backend URL from Terraform output
          cd ../azure-infra
          BACKEND_URL=$(terraform output -raw backend_url)
          cd ../client
          
          # Update frontend with correct backend URL
          echo "VITE_API_BASE_URL=${BACKEND_URL}/api" > .env.production
          npm run build

      - name: Re-upload frontend with correct backend URL
        run: |
          az storage blob upload-batch \
            --destination '$web' \
            --account-name ${{ steps.azure_resources.outputs.STORAGE }} \
            --source client/dist \
            --overwrite

      - name: Output URLs
        working-directory: azure-infra
        run: |
          echo "Frontend: https://${{ steps.azure_resources.outputs.STORAGE }}.z13.web.core.windows.net"
          echo "Backend: $(terraform output -raw backend_url)"
          echo "Backend FQDN: $(terraform output -raw backend_fqdn)"
          echo "Container App Environment: $(terraform output -raw container_app_environment_name)"
          echo "Log Analytics: $(terraform output -raw log_analytics_workspace_name)"
