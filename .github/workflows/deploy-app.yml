name: Deploy Application

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to deploy from"
        required: true
        default: "dev"
      image_tag:
        description: "Image tag to deploy (default latest)"
        required: false
        default: "latest"

permissions:
  contents: read
  packages: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'dev' }}

      - name: Azure CLI Login
        run: |
          az login --service-principal \
            --username ${{ secrets.AZURE_CLIENT_ID }} \
            --password ${{ secrets.AZURE_CLIENT_SECRET }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }}
          az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get resource information
        id: azure_resources
        run: |
          # Always use dev environment since that's where our resources exist
          ENVIRONMENT=dev
          
          # Get storage account name from the resource group
          STORAGE_ACCOUNT=$(az storage account list \
            --resource-group play-learn-spark-${ENVIRONMENT}-rg \
            --query "[0].name" \
            --output tsv)
          
          # Get container group FQDN
          BACKEND_FQDN=$(az container show \
            --name play-learn-spark-${ENVIRONMENT}-backend \
            --resource-group play-learn-spark-${ENVIRONMENT}-rg \
            --query "ipAddress.fqdn" \
            --output tsv 2>/dev/null || echo "")
          
          echo "ENVIRONMENT=${ENVIRONMENT}" >> $GITHUB_OUTPUT
          echo "STORAGE=$STORAGE_ACCOUNT" >> $GITHUB_OUTPUT
          echo "BACKEND=$BACKEND_FQDN" >> $GITHUB_OUTPUT

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build frontend
        working-directory: client
        run: |
          npm ci
          npm run build

      - name: Upload frontend dist to static site
        run: |
          az storage blob upload-batch \
            --destination '$web' \
            --account-name ${{ steps.azure_resources.outputs.STORAGE }} \
            --source client/dist \
            --overwrite

      - name: Update backend container image (recreate)
        run: |
          ENVIRONMENT=${{ steps.azure_resources.outputs.ENVIRONMENT }}
          IMAGE_TAG=${{ github.event.inputs.image_tag || 'latest' }}
          
          az container delete --name play-learn-spark-${ENVIRONMENT}-backend --resource-group play-learn-spark-${ENVIRONMENT}-rg --yes || true
          az container create \
            --name play-learn-spark-${ENVIRONMENT}-backend \
            --resource-group play-learn-spark-${ENVIRONMENT}-rg \
            --image ghcr.io/linoymalakkaran/play-learn-spark-backend:${IMAGE_TAG} \
            --registry-login-server ghcr.io \
            --registry-username ${{ github.actor }} \
            --registry-password ${{ secrets.GITHUB_TOKEN }} \
            --dns-name-label play-learn-spark-${ENVIRONMENT}-backend \
            --ports 3000 \
            --os-type Linux \
            --cpu 0.5 \
            --memory 1.0 \
            --environment-variables NODE_ENV=${ENVIRONMENT} PORT=3000 MONGODB_URI="${{ secrets.MONGODB_ATLAS_URI }}" GOOGLE_AI_KEY="${{ secrets.GOOGLE_AI_API_KEY }}" JWT_SECRET="${{ secrets.JWT_SECRET }}"

      - name: Output URLs
        run: |
          echo "Frontend: https://${{ steps.azure_resources.outputs.STORAGE }}.z13.web.core.windows.net"
          echo "Backend: http://play-learn-spark-${{ steps.azure_resources.outputs.ENVIRONMENT }}-backend.eastus.azurecontainer.io:3000"
