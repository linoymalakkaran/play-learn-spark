# Alternative deployment using Azure Container Instances
# This approach uses Container Instances instead of App Service to avoid quota limits

# Generate random suffix for unique resource names
resource "random_id" "suffix" {
  byte_length = 4
}

# Locals for computed values
locals {
  resource_suffix     = random_id.suffix.hex
  resource_group_name = var.resource_group_name != "" ? var.resource_group_name : "${var.project_name}-${var.environment}-rg"
  
  # Merge environment-specific tags with default tags
  common_tags = merge(var.tags, {
    Environment = var.environment
    CreatedBy   = "Terraform"
    CreatedOn   = timestamp()
  })
}

# Resource Group
resource "azurerm_resource_group" "main" {
  name     = local.resource_group_name
  location = var.location
  tags     = local.common_tags
}

# Container Registry (we'll keep this as it works)
resource "azurerm_container_registry" "main" {
  name                = "${replace(var.project_name, "-", "")}${var.environment}acr${local.resource_suffix}"
  resource_group_name = azurerm_resource_group.main.name
  location            = azurerm_resource_group.main.location
  sku                 = "Basic"
  admin_enabled       = true

  tags = local.common_tags
}

# Container Group for Frontend
resource "azurerm_container_group" "frontend" {
  name                = "${var.project_name}-frontend-${var.environment}-${local.resource_suffix}"
  location            = azurerm_resource_group.main.location
  resource_group_name = azurerm_resource_group.main.name
  ip_address_type     = "Public"
  dns_name_label      = "${var.project_name}-frontend-${var.environment}-${local.resource_suffix}"
  os_type             = "Linux"

  container {
    name   = "frontend"
    image  = "nginx:latest"  # We'll update this later
    cpu    = "0.5"
    memory = "1.5"

    ports {
      port     = 80
      protocol = "TCP"
    }

    environment_variables = {
      NODE_ENV = "production"
      REACT_APP_API_URL = "http://${var.project_name}-backend-${var.environment}-${local.resource_suffix}.${var.location}.azurecontainer.io:3001"
    }
  }

  image_registry_credential {
    server   = azurerm_container_registry.main.login_server
    username = azurerm_container_registry.main.admin_username
    password = azurerm_container_registry.main.admin_password
  }

  tags = local.common_tags
}

# Container Group for Backend
resource "azurerm_container_group" "backend" {
  name                = "${var.project_name}-backend-${var.environment}-${local.resource_suffix}"
  location            = azurerm_resource_group.main.location
  resource_group_name = azurerm_resource_group.main.name
  ip_address_type     = "Public"
  dns_name_label      = "${var.project_name}-backend-${var.environment}-${local.resource_suffix}"
  os_type             = "Linux"

  container {
    name   = "backend"
    image  = "node:20-alpine"  # We'll update this later
    cpu    = "0.5"
    memory = "1.5"

    ports {
      port     = 3001
      protocol = "TCP"
    }

    environment_variables = {
      NODE_ENV = "production"
      PORT = "3001"
      CORS_ORIGIN = "http://${var.project_name}-frontend-${var.environment}-${local.resource_suffix}.${var.location}.azurecontainer.io"
    }
  }

  image_registry_credential {
    server   = azurerm_container_registry.main.login_server
    username = azurerm_container_registry.main.admin_username
    password = azurerm_container_registry.main.admin_password
  }

  tags = local.common_tags
}